package View;

import Model.User;
import Interfaces.Windows;
import java.util.Enumeration;
import java.util.List;
import javax.swing.DefaultListModel;
import javax.swing.JOptionPane;
import javax.swing.tree.DefaultMutableTreeNode;

public class UserViewGUI extends javax.swing.JFrame implements Windows {

    //Main JFrame reference
    private MiniTwitterGUI FrameA;
    
    //Define current's User with followings & newsFeed
    private User user;
    private DefaultListModel followings;
    private DefaultListModel newsFeed;
    /**
     * Creates new form UserViewGUI
     */
    public UserViewGUI(User currentUser) {
        this.user = currentUser;
        this.followings = new DefaultListModel();
        this.newsFeed = new DefaultListModel();
        
        initComponents();
    }
    
    //Save reference from the main JFrame
    @Override
    public void setFrame(Windows frame) {
        this.FrameA = (MiniTwitterGUI) frame;
    }
    
    //Have a popup show up with a message and messageType
    public void PopUpMessage(String message, int messageType){
          JOptionPane.showMessageDialog(null, message, "Alert", messageType);
    }
    
    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jScrollPane1 = new javax.swing.JScrollPane();
        userID = new javax.swing.JTextArea();
        postTweet = new javax.swing.JButton();
        jScrollPane2 = new javax.swing.JScrollPane();
        currentFollowingJList = new javax.swing.JList<>();
        jScrollPane3 = new javax.swing.JScrollPane();
        TweetMessage = new javax.swing.JTextArea();
        followUser = new javax.swing.JButton();
        jScrollPane4 = new javax.swing.JScrollPane();
        newsFeedJList = new javax.swing.JList<>();
        lastUpdateTimeLabel = new javax.swing.JLabel();
        creationTimeLabel = new javax.swing.JLabel();

        setDefaultCloseOperation(javax.swing.WindowConstants.DISPOSE_ON_CLOSE);

        userID.setColumns(10);
        userID.setRows(5);
        jScrollPane1.setViewportView(userID);

        postTweet.setText("POST TWEET");
        postTweet.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                postTweetActionPerformed(evt);
            }
        });

        jScrollPane2.setViewportView(currentFollowingJList);
        currentFollowingJList.setModel(followings);

        TweetMessage.setColumns(10);
        TweetMessage.setRows(5);
        jScrollPane3.setViewportView(TweetMessage);

        followUser.setText("FOLLOW USER");
        followUser.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                followUserActionPerformed(evt);
            }
        });

        jScrollPane4.setViewportView(newsFeedJList);
        newsFeedJList.setModel(newsFeed);

        lastUpdateTimeLabel.setText("Last Tweet: N/A");

        creationTimeLabel.setText("Creation Time: ");

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
        getContentPane().setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, layout.createSequentialGroup()
                        .addComponent(jScrollPane4)
                        .addContainerGap())
                    .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, layout.createSequentialGroup()
                        .addComponent(jScrollPane2)
                        .addContainerGap())
                    .addGroup(layout.createSequentialGroup()
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING, false)
                            .addComponent(lastUpdateTimeLabel, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                            .addComponent(jScrollPane3, javax.swing.GroupLayout.DEFAULT_SIZE, 219, Short.MAX_VALUE))
                        .addGap(31, 31, 31)
                        .addComponent(postTweet, javax.swing.GroupLayout.PREFERRED_SIZE, 135, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addGap(0, 0, Short.MAX_VALUE))
                    .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, layout.createSequentialGroup()
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addComponent(creationTimeLabel, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                            .addGroup(layout.createSequentialGroup()
                                .addComponent(jScrollPane1, javax.swing.GroupLayout.PREFERRED_SIZE, 219, javax.swing.GroupLayout.PREFERRED_SIZE)
                                .addGap(0, 12, Short.MAX_VALUE)))
                        .addGap(18, 18, 18)
                        .addComponent(followUser, javax.swing.GroupLayout.PREFERRED_SIZE, 135, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addGap(35, 35, 35))))
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addGap(15, 15, 15)
                .addComponent(creationTimeLabel, javax.swing.GroupLayout.PREFERRED_SIZE, 22, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(layout.createSequentialGroup()
                        .addGap(18, 18, 18)
                        .addComponent(jScrollPane1, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(jScrollPane2, javax.swing.GroupLayout.PREFERRED_SIZE, 101, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(lastUpdateTimeLabel, javax.swing.GroupLayout.PREFERRED_SIZE, 22, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addGroup(layout.createSequentialGroup()
                                .addGap(15, 15, 15)
                                .addComponent(jScrollPane3, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                                .addGap(18, 18, 18)
                                .addComponent(jScrollPane4, javax.swing.GroupLayout.PREFERRED_SIZE, 101, javax.swing.GroupLayout.PREFERRED_SIZE))
                            .addGroup(layout.createSequentialGroup()
                                .addGap(33, 33, 33)
                                .addComponent(postTweet, javax.swing.GroupLayout.PREFERRED_SIZE, 56, javax.swing.GroupLayout.PREFERRED_SIZE))))
                    .addGroup(layout.createSequentialGroup()
                        .addGap(33, 33, 33)
                        .addComponent(followUser, javax.swing.GroupLayout.PREFERRED_SIZE, 56, javax.swing.GroupLayout.PREFERRED_SIZE)))
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );

        pack();
    }// </editor-fold>//GEN-END:initComponents

    //Follow specific a user
    private void followUserActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_followUserActionPerformed
        
        //Grab User's object from the person you want to follow
        User tryingtoFollow = TraverseJTree(userID.getText());
        
        //Its impossible to follow yourself
        if(user.getUniqueID().equals(userID.getText())){
            PopUpMessage("You can't follow yourself", JOptionPane.WARNING_MESSAGE);
        }
        //Verify if user exists
        else if(tryingtoFollow == null){
            PopUpMessage("User does not exist", JOptionPane.WARNING_MESSAGE);
        }
        //Returns false if you have not followed user yet
        else if (!user.Follow(tryingtoFollow)){
            
            //Update JList widget & Followers list
            updateFollowingList(tryingtoFollow);
            tryingtoFollow.beFollowed(user);
            userID.setText(null);
        }
        //You are already following user
        else{
            PopUpMessage("You are already following this user", JOptionPane.WARNING_MESSAGE);
        }
        
        //For Debugging purposes
        System.out.println("User: " + user.getUniqueID());
        System.out.println("Followings" + user.getFollowings().getListFollowings());
        System.out.println("Followers" + user.getFollowers().getListFollowers());
                
        
    }//GEN-LAST:event_followUserActionPerformed

    //User posted a new tweet
    private void postTweetActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_postTweetActionPerformed
        
        //Update JList & Update everyone that is following currentUser
        user.tweet(user.getUniqueID() + ": " + TweetMessage.getText());
        UpdateNewsFeedList(user.getLastTweet());
        UpdateEveryonesGUI();
        FrameA.tweetSize.addOne();
        FrameA.positiveSize.checkPositiveTweet(TweetMessage.getText());
        FrameA.lastUpdatedUser = user.getUniqueID();
        lastUpdateTimeLabel.setText("Last Tweet: " + user.getLastUpdateTime());
        TweetMessage.setText(null);
    }//GEN-LAST:event_postTweetActionPerformed

    //Load GUI and refresh JList: Followings/NewsFeed 
    @Override
    public void display() {
        
        followings.clear();
        newsFeed.clear();
        followings.addElement("Followings");
        newsFeed.addElement("NewsFeed");
        initialUpdateFollowings();
        initialUpdateNewsFeed();
        
        this.setTitle(user.toString());
        creationTimeLabel.setText("Creation Time: " + user.getTimeStamp());
        this.setVisible(true);
    }
    
    //Update list when a user follows a new person
    public void updateFollowingList(User newFollowing){
        followings.add(1, newFollowing);
    }
    
    //Load all folowings from the list into JList
    public void initialUpdateFollowings(){
        
        List<User> currentFollowings = user.getFollowings().getListFollowings();
        
        for(User each: currentFollowings){
            followings.addElement(each);
        }
    }
    
    //Update list when a tweet is made
    public void UpdateNewsFeedList(String newNews){
        newsFeed.add(1, newNews);
    }
    
    //Load all newsFeed from the list into JList
    public void initialUpdateNewsFeed(){ 
        
         List<String> currentNewsFeed = user.getNewsfeed().getNews();
        
        for(String each: currentNewsFeed){
            this.newsFeed.addElement(each);
        }
    }
    //Update your Followers Newsfeed JList
    public void UpdateEveryonesGUI(){
        
        List<User> currentFollowers = user.getFollowers().getListFollowers();
        
        for (Windows value : FrameA.users.values()) {
            
            UserViewGUI eachUser = (UserViewGUI) value;
            
            if(!eachUser.equals(this) && currentFollowers.contains(eachUser.user)){
                eachUser.UpdateNewsFeedList(eachUser.user.getLastTweet());
            }
        }
    }
    
    //Search for a user by Traversing on Jtree
    public User TraverseJTree(String userName){
        
        Enumeration en = FrameA.root.depthFirstEnumeration();
        while (en.hasMoreElements()) {
            
            DefaultMutableTreeNode node = (DefaultMutableTreeNode) en.nextElement();

            if(node.getUserObject() instanceof User){
               User currentUser = (User) node.getUserObject();
               
                if(currentUser.getUniqueID().equals(userName) && !currentUser.getUniqueID().equals(user.getUniqueID())){
                    return currentUser;
                }
            }
        }
        
        return null;
    }

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JTextArea TweetMessage;
    private javax.swing.JLabel creationTimeLabel;
    private javax.swing.JList<String> currentFollowingJList;
    private javax.swing.JButton followUser;
    private javax.swing.JScrollPane jScrollPane1;
    private javax.swing.JScrollPane jScrollPane2;
    private javax.swing.JScrollPane jScrollPane3;
    private javax.swing.JScrollPane jScrollPane4;
    private javax.swing.JLabel lastUpdateTimeLabel;
    private javax.swing.JList<String> newsFeedJList;
    private javax.swing.JButton postTweet;
    private javax.swing.JTextArea userID;
    // End of variables declaration//GEN-END:variables
}
